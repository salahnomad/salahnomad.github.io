{{/* =============================================
   BREADCRUMBS - VERSION COMPLÈTE & CORRIGÉE
   Inclut JSON-LD + Gestion optimisée des hubs
   ============================================= */}}

{{ if not .IsHome }}
{{ $ancestors := .Ancestors.Reverse }}

{{/* Condition d'affichage corrigée */}}
{{ $shouldShowBreadcrumbs := true }}

{{ if $shouldShowBreadcrumbs }}
<nav aria-label="breadcrumb" class="breadcrumbs" data-breadcrumb-depth="{{ len $ancestors }}">
  <ol class="breadcrumbs-list" itemscope itemtype="https://schema.org/BreadcrumbList">
    
    {{/* Accueil - Position fixe 1 */}}
    <li class="breadcrumbs-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="{{ .Site.Home.RelPermalink }}" class="breadcrumbs-link">
        <span itemprop="name">{{ .Site.Params.breadcrumbHomeName | default "Home" }}</span>
      </a>
      <meta itemprop="position" content="1" />
    </li>

    {{/* Ancêtres avec filtre intelligent */}}
    {{ $position := 2 }}
    {{ range $ancestors }}
      {{ if and (not .IsHome) (ne .Kind "taxonomy") }}
        <li class="breadcrumbs-separator" aria-hidden="true">›</li>
        <li class="breadcrumbs-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a itemprop="item" href="{{ .RelPermalink }}" class="breadcrumbs-link">
            <span itemprop="name">{{ .Title | truncate 45 }}</span>
          </a>
          <meta itemprop="position" content="{{ $position }}" />
        </li>
        {{ $position = add $position 1 }}
      {{ end }}
    {{ end }}

    {{/* Page courante */}}
    <li class="breadcrumbs-separator" aria-hidden="true">›</li>
    <li class="breadcrumbs-item active" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
      <span itemprop="name">{{ .Title | truncate 50 }}</span>
      <meta itemprop="position" content="{{ $position }}" />
    </li>

  </ol>
</nav>

{{/* Schema JSON-LD pour les breadcrumbs */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "{{ .Site.Params.breadcrumbHomeName | default "Home" }}",
      "item": "{{ .Site.Home.Permalink }}"
    }
    {{ $position := 2 }}
    {{ range $ancestors }}
      {{ if and (not .IsHome) (ne .Kind "taxonomy") }}, {
        "@type": "ListItem",
        "position": {{ $position }},
        "name": "{{ .Title }}",
        "item": "{{ .Permalink }}"
      }{{ $position = add $position 1 }}{{ end }}
    {{ end }}
    , {
      "@type": "ListItem",
      "position": {{ $position }},
      "name": "{{ .Title }}",
      "item": "{{ .Permalink }}"
    }
  ]
}
</script>
{{ end }}
{{ end }}