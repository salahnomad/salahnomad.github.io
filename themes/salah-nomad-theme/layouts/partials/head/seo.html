{{/* layouts/partials/head/seo.html - Version FINALE CORRIGÉE et complète */}}

{{- $page := . -}}
{{- $site := .Site -}}
{{- $isHomePage := .IsHome -}}
{{- $isPage := .IsPage -}}
{{- $isTerm := eq .Kind "term" -}}
{{- $isTaxonomy := eq .Kind "taxonomy" -}}

{{- /* --- Définition des variables SEO clés --- */}}
{{- $pageTitle := "" -}}
{{- $finalTitle := "" -}}
{{- $description := .Description | default (.Summary | plainify | truncate 160) | default $site.Params.description -}}
{{- $permalink := .Permalink -}}

{{- /* 1. Logique de définition du Titre de la page (sans le nom du site) */}}
{{- if .Params.seo_title -}}
  {{- $pageTitle = .Params.seo_title -}}
{{- else -}}
  {{- $pageTitle = .Title -}}
{{- end -}}

{{- /* 2. Logique d'assemblage du Titre final pour la balise <title> */}}
{{- if $isHomePage -}}
  {{- $finalTitle = printf "%s | %s" $site.Title $site.Params.description -}}
{{- else -}}
  {{- $finalTitle = printf "%s | %s" $pageTitle $site.Title -}}
{{- end -}}


{{- /* --- Variables Open Graph & Twitter --- */}}
{{- $ogType := cond $isPage "article" "website" -}}
{{- $ogImage := "" -}}
{{- $ogImageAlt := .Params.featured_image_alt | default $pageTitle -}}

{{- with .Params.featured_image -}}
    {{- $imgRes := "" -}}
    {{- $imgRes = $page.Resources.GetMatch . -}}
    {{- if not $imgRes }}{{ $imgRes = resources.Get . }}{{ end -}}
    {{- if $imgRes -}}
        {{- $ogImage = ($imgRes.Fill "1200x630 q85 Center").Permalink -}}
    {{- else if (fileExists (printf "static%s" .)) -}}
        {{- $ogImage = (. | absURL) -}}
    {{- end -}}
{{- end -}}
{{- if not $ogImage -}}
    {{- with $site.Params.logo -}}
        {{- $logoRes := resources.Get . -}}
        {{- with $logoRes -}}
            {{- $ogImage = ($logoRes.Fit "1200x630 q85").Permalink -}}
            {{- $ogImageAlt = printf "%s Logo" $site.Title -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- /* ======================================================================= */ -}}
{{- /* =================== BALISES META STANDARD =================== */ -}}
{{- /* ======================================================================= */ -}}

<title>{{ $finalTitle | plainify }}</title>

<meta name="description" content="{{ $description }}">
<link rel="canonical" href="{{ $permalink }}" />

<!-- Open Graph -->
<meta property="og:title" content="{{ $pageTitle }}">
<meta property="og:description" content="{{ $description }}">
<meta property="og:url" content="{{ $permalink }}">
<meta property="og:site_name" content="{{ $site.Title }}">
<meta property="og:type" content="{{ $ogType }}">
{{- if $ogImage }}
<meta property="og:image" content="{{ $ogImage }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="{{ $ogImageAlt | plainify }}">
{{- end }}
{{- if $isPage }}
<meta property="article:published_time" content="{{ .PublishDate.Format "2006-01-02T15:04:05Z07:00" }}">
<meta property="article:modified_time" content="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
{{- range .Params.tags }}<meta property="article:tag" content="{{ . }}">{{ end -}}
{{- end }}

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ $pageTitle }}">
<meta name="twitter:description" content="{{ $description }}">
{{- with $site.Params.social.twitter }}<meta name="twitter:site" content="@{{ . }}">{{ end }}
{{- with $site.Params.author.twitter }}<meta name="twitter:creator" content="@{{ . }}">{{ end }}
{{- if $ogImage }}<meta name="twitter:image" content="{{ $ogImage }}"><meta name="twitter:image:alt" content="{{ $ogImageAlt | plainify }}">{{ end }}

{{- /* ======================================================================= */ -}}
{{- /* ==================== JSON-LD STRUCTURÉ ======================= */ -}}
{{- /* ======================================================================= */ -}}

{{- /* On conserve la logique qui a résolu les problèmes de Google */ -}}

{{- if $isPage -}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "{{ $pageTitle }}",
  "description": "{{ $description }}",
  "image": "{{ $ogImage }}",
  "datePublished": "{{ .PublishDate.Format "2006-01-02T15:04:05Z07:00" }}",
  "dateModified": "{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}",
  "author": {
    "@type": "Person",
    "name": "{{ $site.Params.author.name }}"
  },
  "publisher": {
    "@type": "Organization", 
    "name": "{{ $site.Title }}",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ absURL $site.Params.logo }}"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ $permalink }}"
  }
}
</script>
{{- end -}}

<!-- Graphe de site -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "{{ $site.BaseURL }}#website",
      "url": "{{ $site.BaseURL }}",
      "name": "{{ $site.Title }}",
      "description": "{{ $site.Params.description }}"
    },
    {
      "@type": "WebPage",
      "@id": "{{ $permalink }}#webpage",
      "url": "{{ $permalink }}",
      "name": "{{ $pageTitle }}",
      "isPartOf": {"@id": "{{ $site.BaseURL }}#website"},
      "datePublished": "{{ .PublishDate.Format "2006-01-02T15:04:05Z07:00" }}",
      "dateModified": "{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}",
      "description": "{{ $description }}"
    }
  ]
}
</script>