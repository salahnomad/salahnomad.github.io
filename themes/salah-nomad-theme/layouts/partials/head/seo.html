{{/* layouts/partials/head/seo.html - Version Optimisée Gestion Hybride */}}

{{- $page := . -}}
{{- $site := .Site -}}
{{- $isHomePage := .IsHome -}}
{{- $isPage := .IsPage -}}
{{- $isTerm := eq .Kind "term" -}}
{{- $isTaxonomy := eq .Kind "taxonomy" -}}

{{- /* --- Variables SEO de base --- */}}
{{- $title := .Title -}}
{{- if $isHomePage }}{{ $title = $site.Title }}{{ end -}}
{{- $description := .Description | default (.Summary | plainify | truncate 160) | default $site.Params.description -}}
{{- $permalink := .Permalink -}}

{{- /* --- Variables Open Graph & Twitter --- */}}
{{- $ogType := cond $isPage "article" "website" -}}
{{- $ogImage := "" -}}
{{- $ogImageAlt := .Params.featured_image_alt | default $title -}}

{{- with .Params.featured_image -}}
    {{- $imgRes := "" -}}
    {{- $imgRes = $page.Resources.GetMatch . -}}
    {{- if not $imgRes }}{{ $imgRes = resources.Get . }}{{ end -}}
    {{- if $imgRes -}}
        {{- $ogImage = ($imgRes.Fill "1200x630 q85 Center").Permalink -}}
    {{- else if (fileExists (printf "static%s" .)) -}}
        {{- $ogImage = (. | absURL) -}}
    {{- end -}}
{{- end -}}
{{- if not $ogImage -}}
    {{- with $site.Params.logo -}}
        {{- $logoRes := resources.Get . -}}
        {{- with $logoRes -}}
            {{- $ogImage = ($logoRes.Fit "1200x630 q85").Permalink -}}
            {{- $ogImageAlt = printf "%s Logo" $site.Title -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- /* ======================================================================= */ -}}
{{- /* =================== BALISES META STANDARD =================== */ -}}
{{- /* ======================================================================= */ -}}

<meta name="description" content="{{ $description }}">
<link rel="canonical" href="{{ $permalink }}" />

<!-- Open Graph -->
<meta property="og:title" content="{{ $title }}">
<meta property="og:description" content="{{ $description }}">
<meta property="og:url" content="{{ $permalink }}">
<meta property="og:site_name" content="{{ $site.Title }}">
<meta property="og:type" content="{{ $ogType }}">
{{- if $ogImage }}
<meta property="og:image" content="{{ $ogImage }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="{{ $ogImageAlt | plainify }}">
{{- end }}
{{- if $isPage }}
<meta property="article:published_time" content="{{ .PublishDate.Format "2006-01-02T15:04:05Z07:00" }}">
<meta property="article:modified_time" content="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
{{- range .Params.tags }}<meta property="article:tag" content="{{ . }}">{{ end -}}
{{- end }}

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ $title }}">
<meta name="twitter:description" content="{{ $description }}">
{{- with $site.Params.social.twitter }}<meta name="twitter:site" content="@{{ . }}">{{ end }}
{{- with $site.Params.author.twitter }}<meta name="twitter:creator" content="@{{ . }}">{{ end }}
{{- if $ogImage }}<meta name="twitter:image" content="{{ $ogImage }}"><meta name="twitter:image:alt" content="{{ $ogImageAlt | plainify }}">{{ end }}

{{- /* ======================================================================= */ -}}
{{- /* ==================== GESTION HYBRIDE JSON-LD ======================== */ -}}
{{- /* ======================================================================= */ -}}

{{- $schema := "" -}}

{{- /* --- CAS 1: Schéma personnalisé fourni dans le front matter --- */ -}}
{{- if .Params.json_ld -}}
    {{- /* Sous-cas 1A: json_ld est "true" → Génération automatique forcée */ -}}
    {{- if eq .Params.json_ld true -}}
        {{- /* On génère automatiquement */ -}}
        {{- $schema = dict "@context" "https://schema.org" -}}
        {{- if $isPage -}}
            {{- $schema = merge $schema (dict
                "@type" "Article"
                "headline" $title
                "description" $description
                "image" $ogImage
                "datePublished" (.PublishDate.Format "2006-01-02T15:04:05Z07:00")
                "dateModified" (.Lastmod.Format "2006-01-02T15:04:05Z07:00")
                "author" (dict "@type" "Person" "name" $site.Params.author.name)
                "publisher" (dict "@type" "Organization" "name" $site.Title "logo" (dict "@type" "ImageObject" "url" (absURL $site.Params.logo)))
                "mainEntityOfPage" (dict "@type" "WebPage" "@id" $permalink)
            ) -}}
        {{- end -}}
    
    {{- /* Sous-cas 1B: json_ld est une string JSON → Conversion en objet */ -}}
    {{- else if eq (printf "%T" .Params.json_ld) "string" -}}
        {{- $schema = .Params.json_ld | transform.Unmarshal -}}
    
    {{- /* Sous-cas 1C: json_ld est déjà un objet → Utilisation directe */ -}}
    {{- else -}}
        {{- $schema = .Params.json_ld -}}
    {{- end -}}

{{- /* --- CAS 2: Génération automatique si pas de schéma personnalisé --- */ -}}
{{- else -}}
    {{- $data := dict "@context" "https://schema.org" -}}
    
    {{- if $isPage -}}
        {{- /* Schéma Article de base */ -}}
        {{- $data = merge $data (dict
            "@type" "Article"
            "headline" $title
            "description" $description
            "image" $ogImage
            "datePublished" (.PublishDate.Format "2006-01-02T15:04:05Z07:00")
            "dateModified" (.Lastmod.Format "2006-01-02T15:04:05Z07:00")
            "author" (dict "@type" "Person" "name" $site.Params.author.name)
            "publisher" (dict 
                "@type" "Organization" 
                "name" $site.Title 
                "logo" (dict "@type" "ImageObject" "url" (absURL $site.Params.logo))
            )
            "mainEntityOfPage" (dict "@type" "WebPage" "@id" $permalink)
        ) -}}
        
    {{- else if $isTerm -}}
        {{- $data = merge $data (dict
            "@type" "CollectionPage"
            "name" $title
            "description" $description
            "url" $permalink
        ) -}}
        
    {{- else if $isHomePage -}}
        {{- $data = merge $data (dict
            "@type" "WebSite"
            "name" $site.Title
            "description" $description
            "url" $permalink
            "publisher" (dict 
                "@type" "Organization" 
                "name" $site.Title 
                "logo" (dict "@type" "ImageObject" "url" (absURL $site.Params.logo))
            )
        ) -}}
    {{- end -}}
    
    {{- $schema = $data -}}
{{- end -}}

{{- /* ======================================================================= */ -}}
{{- /* ==================== AFFICHAGE SÉCURISÉ ============================== */ -}}
{{- /* ======================================================================= */ -}}

{{- with $schema -}}
<script type="application/ld+json">
{{ . | jsonify }}
</script>
{{- end -}}

{{- /* ======================================================================= */ -}}
{{- /* ==================== GRAPHE DE SITE UNIVERSEL ======================== */ -}}
{{- /* ======================================================================= */ -}}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebSite",
      "@id": "{{ $site.BaseURL }}#website",
      "url": "{{ $site.BaseURL }}",
      "name": "{{ $site.Title }}",
      "description": "{{ $site.Params.description }}",
      "publisher": {
        "@type": "Organization",
        "name": "{{ $site.Title }}",
        "logo": {
          "@type": "ImageObject",
          "url": "{{ absURL $site.Params.logo }}"
        }
      }
    },
    {
      "@type": "WebPage", 
      "@id": "{{ $permalink }}#webpage",
      "url": "{{ $permalink }}",
      "name": "{{ $title }}",
      "isPartOf": {"@id": "{{ $site.BaseURL }}#website"},
      "datePublished": "{{ .PublishDate.Format "2006-01-02T15:04:05Z07:00" }}",
      "dateModified": "{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}",
      "description": "{{ $description }}"
    }
  ]
}
</script>