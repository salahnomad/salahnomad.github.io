{{/* layouts/partials/head/seo.html - Version Professionnelle 2025 */}}

{{- $page := . -}}
{{- $site := .Site -}}
{{- $isHomePage := .IsHome -}}
{{- $isPage := .IsPage -}}
{{- $isTerm := eq .Kind "term" -}}
{{- $isTaxonomy := eq .Kind "taxonomy" -}}

{{- /* --- Variables SEO de base --- */}}
{{- $title := .Title -}}
{{- if $isHomePage }}{{ $title = $site.Title }}{{ end -}}
{{- $description := .Description | default (.Summary | plainify | truncate 160) | default $site.Params.description -}}
{{- $permalink := .Permalink -}}

{{- /* --- Variables Open Graph & Twitter --- */}}
{{- $ogType := cond $isPage "article" "website" -}}
{{- $ogImage := "" -}}
{{- $ogImageAlt := .Params.featured_image_alt | default $title -}}

{{- with .Params.featured_image -}}
    {{- $imgRes := "" -}}
    {{- /* Cherche l'image dans les ressources de la page (Bundles) */ -}}
    {{- $imgRes = $page.Resources.GetMatch . -}}
    {{- /* Si non trouvée, cherche dans /assets */ -}}
    {{- if not $imgRes }}{{ $imgRes = resources.Get . }}{{ end -}}
    {{- if $imgRes -}}
        {{- $ogImage = ($imgRes.Fill "1200x630 q85 Center").Permalink -}}
    {{- else if (fileExists (printf "static%s" .)) -}}
        {{- /* Fallback pour les images dans /static */ -}}
        {{- $ogImage = (. | absURL) -}}
    {{- end -}}
{{- end -}}
{{- if not $ogImage -}}
    {{- /* Image de secours : logo du site */ -}}
    {{- with $site.Params.logo -}}
        {{- $logoRes := resources.Get . -}}
        {{- with $logoRes -}}
            {{- $ogImage = ($logoRes.Fit "1200x630 q85").Permalink -}}
            {{- $ogImageAlt = printf "%s Logo" $site.Title -}}
        {{- end -}}
    {{- end -}}
{{- end -}}

{{- /* ======================================================================= */ -}}
{{- /* =================== DÉBUT DES BALISES META GÉNÉRÉES =================== */ -}}
{{- /* ======================================================================= */ -}}

<!-- Méta-description -->
<meta name="description" content="{{ $description }}">

<!-- URL Canonique (Stratégie conservée, elle est correcte) -->
<link rel="canonical" href="{{ $permalink }}" />

<!-- Open Graph -->
<meta property="og:title" content="{{ $title }}">
<meta property="og:description" content="{{ $description }}">
<meta property="og:url" content="{{ $permalink }}">
<meta property="og:site_name" content="{{ $site.Title }}">
<meta property="og:type" content="{{ $ogType }}">
{{- if $ogImage }}
<meta property="og:image" content="{{ $ogImage }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="{{ $ogImageAlt | plainify }}">
{{- end }}
{{- if $isPage }}
<meta property="article:published_time" content="{{ .PublishDate.Format "2006-01-02T15:04:05Z07:00" }}">
<meta property="article:modified_time" content="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
{{- range .Params.tags }}<meta property="article:tag" content="{{ . }}">{{ end -}}
{{- end }}

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ $title }}">
<meta name="twitter:description" content="{{ $description }}">
{{- with $site.Params.author.twitter_handle }}<meta name="twitter:site" content="{{ . }}">{{ end }}
{{- if $ogImage }}<meta name="twitter:image" content="{{ $ogImage }}"><meta name="twitter:image:alt" content="{{ $ogImageAlt | plainify }}">{{ end }}

{{- /* ======================================================================= */ -}}
{{- /* ======================== GESTION DU JSON-LD ========================= */ -}}
{{- /* ======================================================================= */ -}}
{{- $schema := "" -}}
{{- if .Params.json_ld -}}
    {{- /* CAS 1: Un schéma personnalisé est fourni dans le front matter (doit être une chaîne de caractères) */ -}}
    {{- if eq (printf "%T" .Params.json_ld) "string" -}}
        {{- $schema = .Params.json_ld | safeJS -}}
    {{- end -}}
{{- else -}}
    {{- /* CAS 2: Pas de schéma personnalisé, on génère automatiquement */ -}}
    {{- $data := dict "@context" "https://schema.org" -}}
    {{- $publisher := dict "@type" "Organization" "name" $site.Title "logo" (dict "@type" "ImageObject" "url" (absURL $site.Params.logo)) -}}
    {{- $author := dict "@type" "Person" "name" $site.Params.author.name "url" (absURL "/") -}}
    
    {{- if $isPage -}}
        {{- $data = merge $data (dict
            "@type" "Article"
            "mainEntityOfPage" (dict "@type" "WebPage" "@id" $permalink)
            "headline" $title
            "description" $description
            "image" $ogImage
            "datePublished" (.PublishDate.Format "2006-01-02T15:04:05Z07:00")
            "dateModified" (.Lastmod.Format "2006-01-02T15:04:05Z07:00")
            "author" $author
            "publisher" $publisher
        ) -}}
    {{- else if $isTerm -}}
        {{- $data = merge $data (dict
            "@type" "CollectionPage"
            "name" $title
            "description" $description
            "url" $permalink
        ) -}}
    {{- else if $isHomePage -}}
        {{- $data = merge $data (dict
            "@type" "WebSite"
            "name" $site.Title
            "description" $description
            "url" $permalink
            "publisher" $publisher
        ) -}}
    {{- end -}}
    
    {{- if gt (len $data) 1 -}}
        {{- $schema = $data | jsonify -}}
    {{- end -}}
{{- end -}}

{{- with $schema -}}
<script type="application/ld+json">
{{ . }}
</script>
{{- end -}}