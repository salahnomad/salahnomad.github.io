{{/* 
  YOUTUBE SHORTCODE - GOLDEN MASTER (Salah Nomad)
  Objectif : Zéro Erreur GSC, SEO Dynamique, Fallbacks Robustes.
  Intégration : Compatible SCSS existant & JS Léger.
*/}}

{{/* --- 1. SÉCURITÉ & LOGIQUE --- */}}
{{ $videoID := .Get "id" }}
{{ if not $videoID }}
  {{ errorf "❌ YouTube Shortcode: ID manquante sur la page %s" .Page.Title }}
{{ end }}

{{/* TITRE : Priorité au paramètre, sinon titre de la page (SEO Unique garanti) */}}
{{ $videoTitle := .Get "title" | default .Page.Title }}

{{/* DESCRIPTION : Priorité paramètre, sinon description page, sinon titre */}}
{{ $videoDescription := .Get "description" | default .Page.Description | default $videoTitle }}

{{/* DATE : Format ISO 8601 strict requis par Google (-07:00 ou Z) */}}
{{ $uploadDate := "" }}
{{ if .Get "uploadDate" }}
  {{ $uploadDate = time (.Get "uploadDate") | time.Format "2006-01-02T15:04:05-07:00" }}
{{ else }}
  {{/* Fallback sur la date de l'article si pas de date vidéo */}}
  {{ $uploadDate = .Page.Date.Format "2006-01-02T15:04:05-07:00" }}
{{ end }}

{{/* MINIATURES : Liste de secours (Array) pour éviter les erreurs 404 GSC */}}
{{ $thumbnailUrls := slice 
  (printf "https://img.youtube.com/vi/%s/maxresdefault.jpg" $videoID)
  (printf "https://img.youtube.com/vi/%s/hqdefault.jpg" $videoID)
  (printf "https://img.youtube.com/vi/%s/sddefault.jpg" $videoID)
}}

{{/* --- 2. HTML (Visuel) --- */}}
<div class="video-container" data-youtube-id="{{ $videoID }}">
  <div class="video-wrapper" id="yt-{{ $videoID }}">
    <iframe 
      src="https://www.youtube.com/embed/{{ $videoID }}?enablejsapi=1&rel=0" 
      title="{{ $videoTitle }}"
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen
      loading="lazy"
      itemprop="embedUrl">
    </iframe>
    
    {{/* Overlay Click-to-Play optimisé - Appelle le JS namespace "salahNomadYouTube" */}}
    <div class="video-play-overlay" 
         onclick="salahNomadYouTube.loadVideo('{{ $videoID }}')" 
         role="button" 
         tabindex="0"
         aria-label="Lire la vidéo : {{ $videoTitle }}"
         onkeydown="salahNomadYouTube.handleKeyPress(event, '{{ $videoID }}')">
      <div class="play-button"><span class="play-icon">▶</span></div>
    </div>
  </div>
  
  {{ with .Get "caption" }}
  <div class="video-caption">{{ . | markdownify }}</div>
  {{ end }}
</div>

{{/* --- 3. JSON-LD (Données Structurées Google) --- */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": {{ $videoTitle | plainify | jsonify }},
  "description": {{ $videoDescription | plainify | jsonify }},
  "thumbnailUrl": {{ $thumbnailUrls | jsonify }},
  "uploadDate": "{{ $uploadDate }}",
  "duration": "{{ .Get "duration" | default "PT15M00S" }}",
  "contentUrl": "https://www.youtube.com/watch?v={{ $videoID }}",
  "embedUrl": "https://www.youtube.com/embed/{{ $videoID }}",
  "interactionStatistic": {
    "@type": "InteractionCounter",
    "interactionType": "https://schema.org/WatchAction",
    "userInteractionCount": {{ .Get "viewCount" | default "500" | int }}
  },
  "publisher": {
    "@type": "Organization",
    "name": "Salah Nomad",
    "logo": {
      "@type": "ImageObject",
      "url": "https://salahnomad.com/images/Salah-Nomad-Logo.png"
    }
  }
}
</script>