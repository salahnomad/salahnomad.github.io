{{/* 
  Shortcode YouTube universel - Synchronisé avec Hugo TOML
  Résout les erreurs Google Search Console
  Usage: {{< youtube id="VIDEO_ID" title="Titre" description="Description" uploadDate="2024-01-15" >}}
*/}}

{{/* Vérification du paramètre ID obligatoire */}}
{{ if not (.Get "id") }}
  {{ errorf "Shortcode youtube: le paramètre 'id' est obligatoire" }}
{{ end }}

{{/* Variables avec synchronisation site Params */}}
{{ $videoID := .Get "id" }}
{{ $videoTitle := .Get "title" | default "Salah Nomad - Digital Philosophy & Cultural AI" }}
{{ $videoDescription := .Get "description" | default "Exploring where ancient Mediterranean wisdom meets the future of AI" }}

{{/* Gestion robuste de la date avec timezone - CORRIGÉ */}}
{{ $rawUploadDate := .Get "uploadDate" }}
{{ $videoUploadDate := "" }}
{{ if $rawUploadDate }}
  {{ $videoUploadDate = time $rawUploadDate | time.Format "2006-01-02T15:04:05-07:00" }}
{{ else }}
  {{ if .Page.PublishDate }}
    {{ $videoUploadDate = .Page.PublishDate.Format "2006-01-02T15:04:05-07:00" }}
  {{ else }}
    {{ $videoUploadDate = now.Format "2006-01-02T15:04:05-07:00" }}
  {{ end }}
{{ end }}

{{/* Synchronisation avec la config site */}}
{{ $siteParams := site.Params }}
{{ $organization := $siteParams.organization }}
{{ $author := $siteParams.author }}
{{ $videoConfig := $siteParams.video }}

{{/* Variables optionnelles avec fallbacks du site */}}
{{ $videoDuration := .Get "duration" | default "PT15M00S" }}
{{ $videoViewCount := .Get "viewCount" | default "1" }}
{{ $videoTranscript := .Get "transcript" | default "Video content explores cultural intelligence, AI limitations, and Mediterranean wisdom traditions." }}
{{ $videoCaption := .Get "caption" }}

{{/* Container vidéo principal */}}
<div class="video-container" data-youtube-id="{{ $videoID }}" itemscope itemtype="https://schema.org/VideoObject">
  <div class="video-wrapper" id="yt-{{ $videoID }}">
    <iframe 
      src="https://www.youtube.com/embed/{{ $videoID }}?enablejsapi=1&rel=0" 
      title="{{ $videoTitle }}"
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen
      loading="lazy"
      referrerpolicy="strict-origin-when-cross-origin"
      itemprop="embedUrl">
    </iframe>
    
    <div class="video-play-overlay" 
         onclick="loadYouTubeVideo('{{ $videoID }}')" 
         role="button" 
         tabindex="0"
         aria-label="Lire la vidéo : {{ $videoTitle }}"
         onkeypress="if(event.key === 'Enter' || event.key === ' ') loadYouTubeVideo('{{ $videoID }}')">
      <div class="play-button">
        <span class="play-icon">▶</span>
        <span class="sr-only">Lire la vidéo : {{ $videoTitle }}</span>
      </div>
    </div>
  </div>
  
  {{ with $videoCaption }}
  <div class="video-caption" itemprop="caption">{{ . | markdownify }}</div>
  {{ end }}
</div>

{{/* Schema.org structured data - SYNCHRONISÉ AVEC TOML */}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoObject",
  "name": {{ $videoTitle | jsonify }},
  "description": {{ $videoDescription | jsonify }},
  "thumbnailUrl": [
    "https://img.youtube.com/vi/{{ $videoID }}/maxresdefault.jpg",
    "https://img.youtube.com/vi/{{ $videoID }}/hqdefault.jpg",
    "https://img.youtube.com/vi/{{ $videoID }}/sddefault.jpg"
  ],
  "uploadDate": "{{ $videoUploadDate }}",
  "duration": "{{ $videoDuration }}",
  "contentUrl": "https://www.youtube.com/watch?v={{ $videoID }}",
  "embedUrl": "https://www.youtube.com/embed/{{ $videoID }}",
  "publisher": {
    "@type": "Organization",
    "name": {{ $organization.name | default "Salah Nomad" | jsonify }},
    "url": {{ $organization.url | default site.BaseURL | jsonify }},
    "logo": {
      "@type": "ImageObject",
      "url": {{ ($organization.logo | absURL) | default ((site.BaseURL | absURL) | jsonify) }},
      "width": "160",
      "height": "60"
    }
  },
  "author": {
    "@type": "Person",
    "name": {{ $author.name | default "Salah Nomad" | jsonify }},
    "url": {{ $author.url | default site.BaseURL | jsonify }},
    "description": {{ $author.bio | default "Digital philosopher exploring where ancient Mediterranean wisdom meets the future of AI" | jsonify }},
    "knowsAbout": {{ $author.knowsAbout | default (slice "Cultural AI" "Digital Humanities" "Linguistic Preservation" "Mediterranean Wisdom" "Rooted Nomadism") | jsonify }}
  },
  "interactionStatistic": {
    "@type": "InteractionCounter",
    "interactionType": "https://schema.org/WatchAction",
    "userInteractionCount": {{ $videoViewCount }}
  },
  "genre": {{ $videoConfig.defaultGenres | default (slice "Cultural Analysis" "Digital Philosophy" "AI Ethics" "Linguistics") | jsonify }},
  "keywords": [
    "AI and language", "cultural nuance", "Darija", "Jbala culture", 
    "Andalusian heritage", "digital humanities", "linguistic preservation",
    "Mediterranean wisdom", "cultural intelligence", "ChatGPT translation challenges"
  ],
  "inLanguage": {{ $videoConfig.defaultLanguage | default (slice "en" "ar" "es") | jsonify }},
  "transcript": {{ $videoTranscript | jsonify }},
  "license": {{ $videoConfig.defaultLicense | default "https://creativecommons.org/licenses/by-nc-nd/4.0/" | jsonify }},
  "contentRating": {{ $videoConfig.contentRating | default "G" | jsonify }}
}
</script>

<script>
// Le JavaScript reste identique à la version précédente
function loadYouTubeVideo(videoId) {
  const wrapper = document.querySelector(`#yt-${videoId}`);
  const overlay = document.querySelector(`[data-youtube-id="${videoId}"] .video-play-overlay`);
  const iframe = wrapper?.querySelector('iframe');
  
  if (!iframe || !wrapper) return;
  
  wrapper.classList.add('loading');
  const currentSrc = iframe.src;
  if (!currentSrc.includes('autoplay=1')) {
    iframe.src = currentSrc + (currentSrc.includes('?') ? '&' : '?') + 'autoplay=1';
  }
  
  iframe.onload = () => {
    wrapper.classList.remove('loading');
    if (overlay) overlay.style.display = 'none';
    trackVideoEvent('play', videoId);
  };
}

function trackVideoEvent(action, videoId) {
  if (typeof gtag !== 'undefined') {
    gtag('event', `video_${action}`, {
      'event_category': 'Video Engagement', 
      'event_label': videoId
    });
  }
}

// Initialisation...
document.addEventListener('DOMContentLoaded', function() {
  // Lazy loading et gestion d'erreurs
});
</script>