{{ define "main" }}
  {{ $showSidebarOnThisPage := .Site.Params.listPageSidebar | default true }}
  {{ if isset .Params "sidebar" }}{{ $showSidebarOnThisPage = .Params.sidebar }}{{ end }}

  <div class="hub-page-container {{ if $showSidebarOnThisPage }}has-sidebar{{ else }}no-sidebar{{ end }}">
    
    {{/* STRUCTURE EXISTANTE - RESPECTE VOTRE SCSS */}}
    <div class="hub-main-content">
      <article class="hub-page">
        
        <header class="hub-header">
          {{ with .Params.featured_image }}
            {{ $image := $.Resources.GetMatch . }}
            {{ if $image }}
              {{ $image = $image.Fill "1200x400 webp q85 Center" }}
              <img src="{{ $image.RelPermalink }}" alt="{{ $.Params.featured_image_alt | default $.Title }}" class="hub-featured-image" loading="lazy">
            {{ end }}
          {{ end }}
          
          {{ partial "breadcrumbs.html" . }}
          <h1>{{ .Title }}</h1>
          {{ with .Description }}<p class="lead">{{ . }}</p>{{ end }}
          
          {{ with .Params.us_optimization.ia_short_answer }}
            <div class="ia-short-answer-card hub-ia-card">
              <div class="ia-icon">ðŸ¤–</div>
              <div class="ia-content">
                <strong>In a nutshell:</strong> {{ . }}
              </div>
            </div>
          {{ end }}
        </header>

        <div class="hub-content">
          {{ .Content }}
        </div>

        {{/* GRILLE DES ARTICLES */}}
        <section class="hub-spokes-section">
          <div class="posts-list-header">
              <hr class="separator-above-title">
              <h2 class="posts-list-title">Deep Dive into {{ .Title }}</h2>
              <hr class="separator-below-title">
          </div>
          
          {{ $pages := .RegularPagesRecursive.ByDate.Reverse }}
          {{ if $pages }}
          <div class="article-grid list-page-grid">
            {{ range $pages }}
              {{ partial "article-card.html" . }}
            {{ end }}
          </div>
          {{ else }}
          <div class="no-content-message">
            <p>Articles for this collection are being crafted.</p>
          </div>
          {{ end }}
        </section>

        {{/* NAVIGATION CONTEXTUELLE */}}
        {{ $currentSection := .Section }}
        {{ $sections := where (where .Site.Sections "Section" "!=" "") ".Params.headless" "ne" true }}
        {{ $prev := "" }}{{ $next := "" }}
        {{ range $i, $s := $sections }}
          {{ if eq $s.Section $currentSection }}
            {{ if gt $i 0 }}{{ $prev = index $sections (sub $i 1) }}{{ end }}
            {{ if lt (add $i 1) (len $sections) }}{{ $next = index $sections (add $i 1) }}{{ end }}
          {{ end }}
        {{ end }}
        
        {{ if or $prev $next }}
        <nav class="hub-context-nav">
          <h3>Explore Related Hubs</h3>
          <div class="hub-nav-grid">
            {{ with $prev }}
            <a href="{{ .RelPermalink }}" class="hub-nav-card prev-hub">
              <span class="nav-arrow">&larr;</span>
              <div>
                <span class="nav-label">Previous Hub</span>
                <strong>{{ .Title }}</strong>
              </div>
            </a>
            {{ else }}<div></div>{{ end }}
            
            {{ with $next }}
            <a href="{{ .RelPermalink }}" class="hub-nav-card next-hub">
              <div>
                <span class="nav-label">Next Hub</span>
                <strong>{{ .Title }}</strong>
              </div>
              <span class="nav-arrow">&rarr;</span>
            </a>
            {{ end }}
          </div>
        </nav>
        {{ end }}

      </article>
    </div>

    {{/* SIDEBAR - DANS LA STRUCTURE GRID EXISTANTE */}}
    {{ if $showSidebarOnThisPage }}
      {{ partial "sidebar.html" . }}
    {{ end }}

  </div>

  {{/* CSS MINIMAL POUR CORRIGER LE DÃ‰BORDEMENT */}}
  <style>
  /* CORRECTION DU DÃ‰BORDEMENT GAUCHE */
  .hub-page-container {
    box-sizing: border-box;
    overflow-x: hidden;
  }
  
  /* SÃ‰CURITÃ‰ ANTI-DÃ‰BORDEMENT */
  body {
    overflow-x: hidden;
  }
  
  /* ASSURE QUE LES IMAGES NE DÃ‰BORDENT PAS */
  .hub-featured-image,
  .article-card img,
  .responsive-image {
    max-width: 100%;
    height: auto;
  }
  </style>

  {{/* JSON-LD */}}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "{{ .Title }}",
    "description": "{{ .Description }}",
    "url": "{{ .Permalink }}",
    {{ with .Params.us_optimization.ia_short_answer }}
    "abstract": "{{ . | safeJS }}",
    {{ end }}
    "mainEntity": {
      "@type": "ItemList",
      "numberOfItems": {{ len .RegularPagesRecursive }},
      "itemListElement": [
        {{ range $index, $page := .RegularPagesRecursive.ByDate.Reverse }}
        {
          "@type": "ListItem",
          "position": {{ add $index 1 }},
          "item": {
            "@type": "Article",
            "url": "{{ $page.Permalink }}",
            "name": "{{ $page.Title }}",
            "description": "{{ $page.Description | safeJS }}",
            "datePublished": "{{ $page.Date.Format "2006-01-02T15:04:05Z07:00" }}"
          }
        }{{ if ne (add $index 1) (len $.RegularPagesRecursive) }},{{ end }}
        {{ end }}
      ]
    }
  }
  </script>
{{ end }}