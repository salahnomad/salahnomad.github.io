{{ define "main" }}
{{ $showSidebarOnThisPage := .Site.Params.singlePageSidebar | default true }}
{{ if isset .Params "sidebar" }}
  {{ $showSidebarOnThisPage = .Params.sidebar }}
{{ end }}

{{/* --- D√©tection automatique du type de contenu --- */}}
{{ $isBlueprint := eq .Params.frameworks.primary "zellige-blueprint" }}
{{ $isPhilosophy := in .Params.categories "Philosophy" }}
{{ $isComparison := eq .Params.cta "comparison" }}
{{ $hasPrinciples := .Params.show_principles | default true }}

<div class="container single-page-container {{ if $showSidebarOnThisPage }}has-sidebar{{ else }}no-sidebar{{ end }} {{ if .Params.us_optimization }}ia-optimized-layout{{ if $isBlueprint }} blueprint-special-layout{{ end }}{{ end }}">

  <div class="single-main-content">
    
    {{ partial "breadcrumbs.html" . }}

    <article class="post-single hentry {{ if .Params.us_optimization }}ia-optimized-article{{ if $isBlueprint }} blueprint-article{{ end }}{{ end }}" data-pagefind-body>
      
      <!-- En-t√™te conditionnel IA -->
      <header class="post-header {{ if .Params.us_optimization }}ia-optimized-header{{ if $isBlueprint }} blueprint-header{{ end }}{{ end }}">
        {{ if .Params.us_optimization }}
          <!-- En-t√™te optimis√© IA -->
          {{ with .Params.structured_data }}
          <div class="framework-badge-container">
            {{ with .cultural_origin }}<span class="framework-badge origin">{{ . }}</span>{{ end }}
            {{ with .framework_type }}<span class="framework-badge type">{{ . }}</span>{{ end }}
            {{ with .difficulty }}<span class="framework-badge difficulty">{{ . }}</span>{{ end }}
          </div>
          {{ end }}
          
          <h1 class="{{ if .Params.us_optimization }}ia-main-title{{ if $isBlueprint }} blueprint-main-title{{ end }}{{ else }}post-title p-name{{ end }}">{{ .Title }}</h1>
          
          {{ with .Params.us_optimization.usp_angle }}
            <p class="usp-angle">{{ . }}</p>
          {{ end }}
          
          {{ with .Params.us_optimization.ia_short_answer }}
            <div class="ia-short-answer-card">
              <div class="ia-icon">üß†</div>
              <div class="ia-content">
                <strong>In a nutshell:</strong>
                {{ . }}
              </div>
            </div>
          {{ end }}
        {{ else }}
          <!-- En-t√™te normal -->
          <h1 class="post-title p-name">{{ .Title }}</h1>
          {{ partial "post-meta.html" . }}
        {{ end }}
      </header>

      <!-- Image featured -->
      {{ if .Params.featured_image }}
      <figure class="post-featured-image {{ if .Params.us_optimization }}ia-featured-image{{ if $isBlueprint }} blueprint-featured-image{{ end }}{{ end }}">
        {{ partial "responsive-image.html" (dict 
            "src" .Params.featured_image 
            "alt" .Params.featured_image_alt
            "page" . 
            "loading" "eager"
            "sizesKey" "singleFeatured" 
            "caption" .Params.featured_image_caption
            "class" "ia-hero-image"
        )}}
        {{ if and .Params.us_optimization $isBlueprint }}<div class="image-overlay-pattern"></div>{{ end }}
      </figure>
      {{ end }}

      <!-- Contenu principal -->
      <div class="post-content e-content {{ if .Params.us_optimization }}ia-optimized-content{{ if $isBlueprint }} blueprint-content{{ end }}{{ end }}">
        
        {{ if .Params.us_optimization }}
        <!-- Contenu avec optimisation IA -->
        <div class="ia-content-intro">
          {{ .Content }}
        </div>

        <!-- Section Principes Universelle -->
        {{ if and $hasPrinciples .Params.us_optimization }}
        <section class="universal-principles">
          <h2>Core Principles</h2>
          <div class="principles-grid">
            {{ with .Params.principles }}
              <!-- Principes personnalis√©s depuis le front matter -->
              {{ range . }}
              <div class="principle-card" data-principle="{{ .name | urlize }}">
                <div class="principle-icon">{{ .icon }}</div>
                <h3>{{ .name }}</h3>
                <p>{{ .description }}</p>
              </div>
              {{ end }}
            {{ else }}
              <!-- Principes par d√©faut (Zellige) -->
              <div class="principle-card" data-principle="firmitas">
                <div class="principle-icon">üèõÔ∏è</div>
                <h3>Firmitas</h3>
                <p>Strength and resilience - A system that doesn't collapse under pressure</p>
              </div>
              <div class="principle-card" data-principle="utilitas">
                <div class="principle-icon">‚öôÔ∏è</div>
                <h3>Utilitas</h3>
                <p>Practical utility - Every element serves a clear purpose</p>
              </div>
              <div class="principle-card" data-principle="venustas">
                <div class="principle-icon">üé®</div>
                <h3>Venustas</h3>
                <p>Beauty and delight - A system that nourishes soul and spirit</p>
              </div>
            {{ end }}
          </div>
        </section>
        {{ end }}

        <!-- CTA Universel -->
        {{ if .Params.us_optimization }}
        <div class="universal-cta">
          <h3>{{ .Params.cta_title | default "Ready to Transform Your Work?" }}</h3>
          <p>{{ .Params.cta_description | default "Join our community and start your journey toward more meaningful productivity." }}</p>
          <a href="{{ .Params.cta_link | default "#action" }}" class="btn btn-universal">
            {{ .Params.cta_button | default "Get Started" }}
          </a>
        </div>
        {{ end }}

        {{ else }}
        <!-- Contenu normal -->
        {{ .Content }}
        {{ end }}

      </div>
      
      {{ if .Params.cta }}
        {{ partial "cta-ebook.html" (dict "cta" .Params.cta "Page" .) }}
      {{ end }}

      <!-- FAQ Universelle -->
      {{ if .Params.faq }}
      <section class="universal-faq">
        <h2>‚ùì Frequently Asked Questions</h2>
        <div itemscope itemtype="https://schema.org/FAQPage">
          {{ range .Params.faq }}
          {{ partial "short-faq.html" (dict "question" .question "answer" .answer) }}
          {{ end }}
        </div>
      </section>
      {{ end }}

      <footer class="post-footer {{ if .Params.us_optimization }}ia-optimized-footer{{ end }}">
        {{ partial "post-tags.html" . }}
        {{ partial "post-share.html" . }}
      </footer>
    </article>

    {{ partial "author-bio.html" . }}
    {{ partial "related-posts.html" . }}
    {{ partial "comments.html" . }}

  </div>

  {{ if $showSidebarOnThisPage }}
    {{ partial "sidebar.html" . }}
  {{ end }}

</div>
{{ end }}