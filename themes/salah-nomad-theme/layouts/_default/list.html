{{/* 
  FICHIER CORRIGÃ‰ : themes/salah-nomad-theme/layouts/_default/list.html
  -----------------------------------------------------------------------
  Solution garantie pour afficher les articles dans les sections
*/}}

{{ define "main" }}
  <div class="container main-content-container">

    {{ $showSidebar := .Params.sidebar | default (.Site.Params.listPageSidebar | default true) }}
    <div class="content-loop-wrap {{ cond $showSidebar "has-sidebar" "no-sidebar" }}">

      <div class="post-list content-loop">
        
        {{/* ðŸ†• AJOUT BREADCRUMBS POUR LES HUBS */}}
        {{ if and (not .IsHome) (ne .Kind "taxonomy") }}
          {{ partial "breadcrumbs.html" . }}
        {{ end }}
        
        <header class="page-header list-page-header">
          <h1 class="page-title list-page-title">{{ .Title }}</h1>
          {{ with .Content }}
            <div class="page-description list-page-description taxonomy-description">{{ . }}</div>
          {{ end }}
        </header>
        
        {{/* --- Image en Vedette de la Section (Code inchangÃ©) --- */}}
        {{ $sectionImageSrc := "" }}
        {{ $imagePathInFrontMatter := .Params.featured_image }}

        {{ if $imagePathInFrontMatter }}
            {{ if strings.HasPrefix $imagePathInFrontMatter "http" }}
                {{ $sectionImageSrc = $imagePathInFrontMatter }}
            {{ else }}
                {{ $imgRes := "" }}
                {{ $imgRes = .Resources.GetMatch $imagePathInFrontMatter }}
                {{ if not $imgRes }}{{ $imgRes = resources.Get $imagePathInFrontMatter }}{{ end }}

                {{ if $imgRes }}
                    {{ $sectionImageSrc = $imgRes }}
                {{ else }}
                    {{ if strings.HasPrefix $imagePathInFrontMatter "/" }}
                        {{ if fileExists (printf "static%s" $imagePathInFrontMatter) }}
                            {{ $sectionImageSrc = $imagePathInFrontMatter | relURL }}
                        {{ end }}
                    {{ else }}
                        {{ if fileExists (printf "%s%s" .File.Dir $imagePathInFrontMatter) }}
                            {{ $sectionImageSrc = printf "%s%s" .RelPermalink $imagePathInFrontMatter }}
                        {{ end }}
                    {{ end }}
                {{ end }}
            {{ end }}
        {{ end }}

        {{ if $sectionImageSrc }}
          <figure class="section-featured-image">
            {{ partial "responsive-image.html" (dict
                "src" $sectionImageSrc
                "alt" (.Params.featured_image_alt | default (printf "Image d'illustration pour la section %s" (.Title | plainify)))
                "page" .
                "loading" "lazy"
                "sizesKey" "singleFeatured" 
                "class" "section-page-featured-img"
                "figureClass" "section-page-featured-figure"
                "caption" .Params.featured_image_caption
            )}}
          </figure>
        {{ end }}
        {{/* --- Fin Image en Vedette --- */}}

        
        {{/* ========================================================================= */}}
        {{/* ==================== SOLUTION DÃ‰FINITIVE ================================ */}}
        {{/* ========================================================================= */}}

        {{ $pagesToList := .RegularPages }}

        {{/* Si RegularPages est vide, essayons une autre mÃ©thode */}}
        {{ if eq (len $pagesToList) 0 }}
          {{ $pagesToList = where .Site.RegularPages "Section" .Section }}
        {{ end }}

        {{/* Tri par date */}}
        {{ $pagesToList = $pagesToList.ByDate.Reverse }}

        {{ $paginator := .Paginate $pagesToList }}
        

        {{ if $paginator.Pages }}
          <div class="posts-list-header">
            <hr class="separator-above-title">
            <h2 class="posts-list-title">{{ i18n "articlesInSection" | default (printf "Explorations in %s" .Title) }}</h2>
            <hr class="separator-below-title">
          </div>

          <div class="article-grid list-page-grid">
            {{ range $paginator.Pages }}
              {{ partial "article-card.html" . }}
            {{ end }}
          </div>

          {{ if gt $paginator.TotalPages 1 }}
            <nav class="navigation pagination" role="navigation" aria-label="{{ i18n "postsNavigation" | default "Posts navigation" }}">
                {{ template "_internal/pagination.html" . }}
            </nav>
          {{ end }}

        {{ else }}
          {{ if not .Content }} 
            <p class="no-posts text-center">{{ i18n "noPostsInSection" | default "No posts found in this section." }}</p>
          {{ end }}
        {{ end }}

      </div><!-- /.post-list.content-loop -->

      {{ if $showSidebar }}
         {{ partial "sidebar.html" . }}
      {{ end }}

    </div><!-- /.content-loop-wrap -->
  </div><!-- /.container.main-content-container -->
{{ end }}